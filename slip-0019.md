# SLIP-0019 : Proof of Ownership

```
Number:  SLIP-0019
Title:   Proof of Ownership
Type:    Standard
Status:  Draft
Authors: TBD
Created: 2019-04-25
```

## Abstract

This specification defines the format for a proof of ownership which can be passed to a hierarchical deterministic wallet together with each input of an unsigned transaction. This proof allows the wallet to determine whether it is able to spend the given input or not. It also allows third parties to verify that a user has the ability to spend the input.

## Motivation

In certain applications like CoinJoin and Lightning, a wallet has to sign transactions containing external inputs. To calculate the actual amount the user is spending, the wallet needs to reliably determine for each input whether it belongs to the wallet or not. Without such a mechanism an attacker can fool the wallet into displaying incorrect information about the amount being spent, which can result in theft of user funds.

For example, in a CoinJoin transaction an attacker can construct a transaction with inputs `in1` and `in2` of identical value belonging to the user and two outputs of identical value, `user_out` belonging to the user and `attacker_out` belonging to the attacker. If such a transaction is sent to a hardware wallet twice with `in1` marked as external the first time and `in2` marked as external the second time, then the hardware wallet will display two signing requests to the user for a transfer amount of `in2 - user_out` and `in1 - user_out`, respectively. The user will think that they are signing two different CoinJoin transactions and spending `in1 + in2 - 2*user_out` for the fees, while in reality they are signing two different inputs to a single transaction and sending half of the amount to the attacker.

To mitigate such an attack, the hardware wallet needs to ascertain non-ownership of all inputs which are claimed to be external. In case of hierarchical deterministic wallets it is generally not feasible to ascertain this solely based on the scriptPubKey of the UTXO, because it would require searching through billions of BIP32 derivation paths. Furthermore, even though CoinJoin transactions currently work only with P2WPKH addresses, other applications may require more complicated inputs including multi-signature and Schnorr multi-signature in the future.

A CoinJoin coordinator can also benefit from such a proof to verify that the CoinJoin participant is able and willing to sign the input. This verification helps to mitigate denial of service attacks as the attacker has to use a limited UTXO set that they control and in case of misbehavior this UTXO set gets banned.

## Proof of ownership format

A proof of ownership consists of a proof body and a signature. The proof body contains one or more ownership identifiers which allow a wallet to efficiently determine whether or not it is able to spend a UTXO having a given scriptPubKey. The proof signature affirms that the proof body can be trusted to have been generated by the true owner of the UTXO.

```
proofOfOwnership = proofBody || proofSignature
```

### Ownership identifier

Let *k* be a secret *ownership identification key* derived from the wallet's master secret using the [SLIP-0021](https://github.com/satoshilabs/slips/blob/master/slip-0021.md) method for hierarchical derivation of symmetric keys as:

```
k = Key(m/"SLIP-0019"/"Ownership identification key")
```

The ownership identifier for a scriptPubKey is computed as:

```
id = HMAC-SHA256(key = k, msg = scriptPubKey)
```

In case of *k*-of-*n* multi-signature scriptPubKeys the proof of ownership SHOULD contain the ownership identifiers of all *n* co-owners of that scriptPubKey.

### Proof body

The *proofBody* is a concatenation of the following fields:

* *version* (4 bytes): b"\x53\x4c\x00\x19".
* *flags* (1 byte, bit 0 is the least significant bit):
  * Bit 0: User confirmation
    * 0 means the proof was generated without user confirmation.
    * 1 means the user confirmed the generation of the proof.
  * Bits 1 to 7: Reserved for future use (all must be 0).
* *n* (VarInt): the number of ownership identifiers which follow.
* *id*<sub>1</sub> || *id*<sub>2</sub> || ... || *id*<sub>*n*</sub> (32 bytes each): concatenation of the ownership identifiers for the given scriptPubKey, one for each co-owner.

### Proof footer

The *proofFooter* is a concatenation of the following fields:

* *scriptPubKey* (length-prefixed string).
* *commitmentData* (length-prefixed string), any additional data to which the proof should commit, see below.

The proof footer is not a part of the proof of ownership. It is included only in the *sighash* computation. Variable-length fields are encoded the same way as in Bitcoin transactions, as a length-prefixed string, where the length is encoded as a variable-length integer (VarInt).

### Proof signature

The *proofSignature* is the `SignatureProof` container defined in [BIP-0322](https://github.com/bitcoin/bips/blob/master/bip-0322.mediawiki) using the sighash computed as:

```
sighash = SHA-256(proofBody || proofFooter)
```

### Additional commitment data

The content of the *commitmentData* field is application-specific. If an application does not define the content of this field, then a zero-length string should be used by default.

In case of CoinJoin transactions the *commitmentData* SHOULD contain a globally unique PSBT identifier (*psbtId*). The purpose of such an identifier is to prevent an attacker from causing denial of service by registering an input into a different CoinJoin transaction than the one for which the input was intended. The user should explicitly confirm the generation of the proof and the *commitmentData* value to affirm their intent to participate in the given CoinJoin transaction.

The *psbtId* is not to be confused with TXID, which is the hash of a transaction's data. Since the *psbtId* needs to be known before the transaction is created, it cannot be derived from the transaction data but needs to be generated as a nonce. For example:

1. The concatenation of a globally unique CoinJoin server identifier (192 bits) with a sequential round identifier (64 bits).
2. A random 256 bit value.

## Proof construction

### Single-signature scriptPubKeys

The inputs to the wallet are the *flags*, *scriptPubKey*, *commitmentData* and the BIP32 derivation path.

1. Ensure that bits 1 through 7 of *flags* are clear.
2. Ensure that the wallet controls the private key to the provided *scriptPubKey*. This is typically done by using the provided BIP32 derivation path.
3. If the user confirmation bit (0) of *flags* is set, then prompt the user to confirm generation of the ownership proof with the given *commitmentData*. If the user does not confirm, then abort.
4. Generate the ownership identifier.
5. Compile the *proofBody* and *proofFooter*, and generate the *proofSignature*.
6. Return the *proofBody* and *proofSignature*.

### Multi-signature scriptPubKeys

The construction of a proof of ownership for a *k*-of-*n* multi-signature scriptPubKey requires a signing coordinator, i.e. a watch-only software wallet. The signing coordinator is assumed to have obtained the ownership identifiers of all *n* co-owners in advance. These ownership identifiers should generally be produced at the time of the creation of the multi-signature address.

When constructing a proof of ownership, the signing coordinator prepares the *proofBody* and *proofFooter* and sends these to each signer together with any other required metadata, such as the BIP32 derivation path for the input. Each of the *k* signers then take the following steps:

1. Parse the *proofBody* and *proofFooter*. If the *version* is not recognized or if any of the bits 1 through 7 of *flags* is set, then abort.
2. Derive the ownership identifier using the *scriptPubKey* provided in the *proofFooter*.
3. If the derived ownership identifier is not listed in the *proofBody*, then abort.
4. If the user confirmation bit (0) of *flags* is set, then prompt the user to confirm generation of the ownership proof with the given *commitmentData*. If the user does not confirm, then abort.
5. Return the signature for the provided *proofBody* and *proofFooter*.

The signing coordinator collects all the signatures and combines them into a `SignatureProof` container to finalize the proof.

## Proof usage

### Verifying non-ownership of transaction inputs

When a wallet is requested to sign a transaction, each external input SHOULD be accompanied with a proof of ownership so that the wallet may ascertain non-ownership of such an input in order to correctly inform the user about the amount they are spending in the transaction. For each external input the wallet takes the following steps:

1. By reliable means obtain the scriptPubKey of the UTXO being spent by that input. Prior to SegWit version 1 witness programs this step involves acquiring the full transaction being spent and verifying its hash against that which is given in the outpoint.
2. Verify that the *proofSignature* is valid using the obtained scriptPubKey.
3. Derive the ownership identifier using the wallet's ownership identification key and the obtained scriptPubKey.
4. Verify that the derived ownership identifier is not included in the *proofBody*.

### Verifying ability and intent to spend an input

Each input which is registered to take part in a CoinJoin transaction should be accompanied with a proof of ownership which affirms the owner's intent to take part, so as to mitigate denial of service attacks. The CoinJoin coordinator takes the following steps before registering an input:

1. By reliable means obtain the scriptPubKey of the UTXO being spent by that input.
2. Verify that the *proofSignature* is valid using the obtained scriptPubKey.
3. Verify that the user confirmation bit (0) of *flags* is set.

## PSBT (BIP 174) extension

The following new global field type is added to the BIP-0174 specification:

* Type: Proof of ownership PSBT_GLOBAL_PSBT_ID = 0x0A
  * Key: None. The key must only contain the 1 byte type.
    * `{0x02}`
  * Value: A globally unique PSBT identifier. This value should be used as the *commitmentData*.
    * `{psbtId}`

The following new per-input field type is added to the BIP-0174 specification:

* Type: Proof of ownership PSBT_IN_PROOF_OF_OWNERSHIP = 0x0A
  * Key: None. The key must only contain the 1 byte type.
    * `{0x0A}`
  * Value: The *proofOfOwnership* as defined above.
    * `{proofOfOwnership}`

## Script evaluation on hardware wallets

Currently most hardware wallets don't support complete Bitcoin script verification, so initial deployment of the proof can be limited to a set of known scripts. In the future hardware wallets may implement [miniscript](http://bitcoin.sipa.be/miniscript/) verification, that will cover most of the use-cases known today.

## Test vectors

TODO

## References

* [BIP-0174](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): Partially Signed Bitcoin Transaction Format
* [BIP-0322](https://github.com/bitcoin/bips/blob/master/bip-0322.mediawiki): Generic Signed Message Format
